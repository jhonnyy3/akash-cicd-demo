name: Test Wallet Accessibility

on:
  workflow_dispatch:

jobs:
  test-wallet:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Install Akash CLI
        run: |
          curl https://raw.githubusercontent.com/akash-network/node/main/install.sh | sh
          echo "$HOME/bin" >> $GITHUB_PATH
          akash version

      - name: Verify Wallet
        env:
          AKASH_WALLET_NAME: ${{ secrets.AKASH_WALLET_NAME }}
          AKASH_WALLET_MNEMONIC: ${{ secrets.AKASH_WALLET_MNEMONIC }}
        run: |
          echo "Wallet Name: $AKASH_WALLET_NAME"
          echo "Mnemonic length (for debug, masked): $(echo -n "$AKASH_WALLET_MNEMONIC" | wc -w) words"
          if [ -z "$AKASH_WALLET_NAME" ] || [ -z "$AKASH_WALLET_MNEMONIC" ]; then
            echo "Error: AKASH_WALLET_NAME or AKASH_WALLET_MNEMONIC is not set."
            exit 1
          fi
          echo "Restoring wallet..."
          # Explicitly handle the restore command
          echo "$AKASH_WALLET_MNEMONIC" > mnemonic.txt
          akash keys restore "$AKASH_WALLET_NAME" --keyring-backend test < mnemonic.txt
          RESTORE_STATUS=$?
          rm mnemonic.txt  # Clean up
          if [ $RESTORE_STATUS -ne 0 ]; then
            echo "Failed to restore wallet (exit code: $RESTORE_STATUS)"
            exit 1
          fi
          echo "Listing keys..."
          akash keys list --keyring-backend test
          echo "Retrieving address..."
          AKASH_ADDR=$(akash keys show "$AKASH_WALLET_NAME" -a --keyring-backend test)
          if [ $? -ne 0 ]; then
            echo "Failed to retrieve wallet address"
            exit 1
          fi
          echo "Recovered Wallet Address: $AKASH_ADDR"
